---
Status: Ready for Review
Epic: 1
Story: 1.2.1
Title: Create public medication search API endpoint
---

## Story

**As a** Frontend Application,
**I want** a public API endpoint to search for medications by name,
**so that** I can display search results to the user on the "Public Medication Search" screen.

## Acceptance Criteria

1.  A public `GET /api/medications` endpoint is created that adheres to the contract defined for this path in [`Medications-API.txt`](../../docs/architecture/OpenAPI/Medications-API.txt).
2.  The endpoint accepts a `name` query parameter and returns a `200 OK` response with a JSON array of `Medication` objects matching the search term via a case-insensitive `LIKE` query. The response body must match the `Medication` schema in [`Medications-API.txt`](../../docs/architecture/OpenAPI/Medications-API.txt).
3.  If the `name` parameter is absent, null, or empty, the endpoint returns all medications with a `status` of `active`.
4.  The endpoint is protected by a Feature Test that validates the success case (AC #2), the empty search case (AC #3), and the empty result set (returns an empty array). The test must follow the 'Backend API Test' template from [`testing-strategy.md`](../../docs/architecture/testing-strategy.md).

## Tasks / Subtasks

- [x] **Backend: Create Search Endpoint (AC: #1, #2, #3)**
  - [x] Create a new public route `GET /api/medications` in `backend/routes/api.php`. This route must not be behind the `auth:sanctum` middleware, as shown in the routing examples in [`backend-architecture.md`](../../docs/architecture/backend-architecture.md).
  - [x] In `backend/app/Http/Controllers/MedicationController.php`, create an `index` method. This controller must be lean, delegating all business logic to a service class as per the 'Controller Template' rule in [`backend-architecture.md`](../../docs/architecture/backend-architecture.md).
  - [x] Create and implement a `search` method in a new `backend/app/Services/MedicationService.php`. This method must contain the logic to:
    - Check if the `name` parameter is present and non-empty.
    - If present, perform a case-insensitive `WHERE name LIKE '%...%'` query using the `App\Models\Medication` Eloquent model.
    - If absent, perform a `WHERE status = 'active'` query to retrieve all active medications, also using the `App\Models\Medication` model.
    - This adheres to the Service -> Eloquent Model data access pattern mandated in [`backend-architecture.md`](../../docs/architecture/backend-architecture.md), which explicitly prohibits the Repository pattern.
  - [x] Ensure the controller returns a JSON array of medication objects matching the `Medication` schema defined in [`Medications-API.txt`](../../docs/architecture/OpenAPI/Medications-API.txt).
- [x] **Backend: Create Feature Test (AC: #4)**
  - [x] Create a new feature test in `backend/tests/Feature/Medication/` to validate the `GET /api/medications` endpoint, following the project structure in [`testing-strategy.md`](../../docs/architecture/testing-strategy.md).
  - [x] The test must follow the 'Backend API Test (Feature Test)' template from [`testing-strategy.md`](../../docs/architecture/testing-strategy.md).
  - [x] The test should seed the database with sample medications (using the `Medication` factory), call the endpoint with various search terms, and assert that the correct medications and status codes are returned.

## Dev Notes

### API Contract
The implementation of this endpoint **must** strictly follow the specification for `GET /medications` defined in [`Medications-API.txt`](../../docs/architecture/OpenAPI/Medications-API.txt).
- **Endpoint**: `GET /api/medications`
- **Authentication**: Public (no token required).
- **Query Parameter**: `name` (string).
- **Success Response**: `200 OK` with a JSON array of medication objects matching the `Medication` schema.
- **Error Response**: Standard Laravel JSON error response, as defined in [`error-handling-strategy.md`](../../docs/architecture/error-handling-strategy.md).

### Data Models
- The backend will query and return instances of the `App\Models\Medication` Eloquent model, which is detailed in [`data-models.md`](../../data-models.md).

### Architecture & Implementation
- The backend is a **Laravel** monolith connecting to an **SQLite** database, as specified in [`tech-stack.md`](../../docs/architecture/tech-stack.md).
- All data access **must** occur directly through Eloquent models within the Service layer. The three-tier structure (Controller -> Service -> Eloquent Model) is mandated by [`backend-architecture.md`](../../docs/architecture/backend-architecture.md).
- All code must adhere to the project's coding conventions, as outlined in [`coding-standards.md`](../../docs/architecture/coding-standards.md).

### Testing
- A **Feature test** is required to validate the full request-response cycle of the API endpoint. This test will live in `backend/tests/Feature/Medication/` and should cover multiple scenarios (match found, no match found, empty search). The testing strategy is detailed in [`testing-strategy.md`](../../docs/architecture/testing-strategy.md).

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-01 | 1.0 | Initial draft created from parent story 1.2 | Scrum Master |

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

1. All tasks have been completed successfully.
2. The API endpoint has been implemented according to the specifications.
3. Feature tests have been created and are passing.

### File List

- backend/app/Http/Controllers/MedicationController.php
- backend/app/Http/Requests/Medications/SearchMedicationRequest.php
- backend/app/Http/Resources/MedicationResource.php
- backend/app/Services/MedicationService.php
- backend/routes/api.php
- backend/tests/Feature/Feature/Medication/SearchMedicationTest.php

## QA Results

### Review Summary

| Aspect | Status | Notes |
| :--- | :--- | :--- |
| **Requirements Traceability** | ✅ PASS | All acceptance criteria are fully covered by the feature test. |
| **Code Quality & Standards** | ✅ PASS | Implementation adheres to all documented architectural and coding standards. |
| **Risk & NFR Assessment** | ✅ PASS | The endpoint is secure for its purpose. Performance is acceptable for the current scale. |
| **Test Design & Coverage** | ✅ PASS | The feature test is comprehensive and covers all required scenarios. |

### Detailed Findings

1.  **Adherence to Standards:** The implementation correctly follows the Controller -> Service -> Eloquent Model pattern, uses FormRequest for validation, and API Resources for responses as mandated by the project's architecture documents.
2.  **Test Coverage:** The feature test in `SearchMedicationTest.php` is robust, covering the name search, the default case (all active medications), and the empty result set scenario.
3.  **Security:** The endpoint is correctly configured as public. The use of Eloquent's query builder mitigates SQL injection risks.
4.  **Performance Consideration (Minor Concern):** The use of a `LIKE` query with leading and trailing wildcards (`%name%`) can lead to performance degradation on very large datasets. While acceptable for the current project scale, it is recommended to consider a full-text search solution for future scalability. An index on the `medications.name` column is in place, which is good practice.

### Quality Gate Decision

**Result:** PASS

The story meets all quality standards and is approved to proceed.