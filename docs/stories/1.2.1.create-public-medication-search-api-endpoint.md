---
Status: Done
Epic: 1
Story: 1.2.1
Title: Create public medication search API endpoint
---

## Story

**As a** Frontend Application,
**I want** a public API endpoint to search for medications by name,
**so that** I can display search results to the user on the "Public Medication Search" screen.

## Acceptance Criteria

1.  A public `GET /api/medications` endpoint is created that adheres to the contract defined in [`Medications-API.txt`](../../docs/OpenAPI/Medications-API.txt).
2.  The endpoint accepts a `name` query parameter and returns a `200 OK` response with a JSON array of `Medication` objects matching the search term via a case-insensitive `LIKE` query.
3.  If the `name` parameter is absent, null, or empty, the endpoint returns all medications with an `active` status.
4.  The endpoint is protected by a Feature Test that validates the success case (AC #2), the empty search case (AC #3), and the empty result set (returns an empty array).

## Tasks / Subtasks

- [x] **Backend: Create Search Endpoint (AC: #1, #2, #3)**
  - [x] Create a new public route `GET /api/medications` in `backend/routes/api.php`. This route must not be behind the `auth:sanctum` middleware.
  - [x] In `backend/app/Http/Controllers/MedicationController.php`, create an `index` method. This controller must be lean, delegating all logic to a service class as per the 'Controller Template' rule in [`backend-architecture.md`](../../docs/architecture/backend-architecture.md).
  - [x] Create and implement a `search` method in a new `backend/app/Services/MedicationService.php`. This method must contain the logic to check if the `name` parameter is present and non-empty. If it is, call the repository to search by name; otherwise, call the repository to retrieve all **active** medications.
  - [x] Implement the data retrieval logic in `backend/app/Repositories/Eloquent/EloquentMedicationRepository.php`. This repository will need to support two scenarios: (1) a method to perform a case-insensitive `WHERE name LIKE '%...%'` query, and (2) a method to perform a `WHERE active = true` query for when the `name` parameter is not provided. This must adhere to the Repository Pattern defined in [`backend-architecture.md`](../../docs/architecture/backend-architecture.md).
  - [x] Ensure the controller returns a JSON array of medication objects matching the `Medication` schema in [`Medications-API.txt`](../../docs/OpenAPI/Medications-API.txt).
- [x] **Backend: Create Feature Test (AC: #4)**
  - [x] Create a new feature test in `backend/tests/Feature/Medication/` to validate the `GET /api/medications` endpoint.
  - [x] The test must follow the 'Backend API Test (Feature Test)' template from [`testing-strategy.md`](../../docs/architecture/testing-strategy.md).
  - [x] The test should seed the database with sample medications (using the `Medication` factory), call the endpoint with various search terms, and assert that the correct medications and status codes are returned.

## Dev Notes

### Information Architecture

This API endpoint directly supports the **Public Medication Search** screen (node `B`) defined in the site map in [`information-architecture-ia.md`](../../docs/front-end-spec/information-architecture-ia.md).

### API Contract

The implementation of this endpoint **must** strictly follow the specification for `GET /medications` defined in [`Medications-API.txt`](../../docs/OpenAPI/Medications-API.txt).

- **Endpoint**: `GET /api/medications`
- **Authentication**: Public (no token required).
- **Query Parameter**: `name` (string). Note: The OpenAPI spec correctly identifies the parameter as `name`.
- **Success Response**: `200 OK` with a JSON array of medication objects matching the `Medication` schema.
- **Error Response**: Standard Laravel JSON error response.

### Data Models

- The backend will query and return instances of the `App\Models\Medication` Eloquent model, which is detailed in [`data-models.md`](../../docs/architecture/data-models.md).

### Architecture & Implementation

- The overall project structure is defined in [`unified-project-structure.md`](../../docs/architecture/unified-project-structure.md).
- The backend is a **Laravel** monolith connecting to an **SQLite** database, as specified in [`docs/architecture/tech-stack.md`](../../docs/architecture/tech-stack.md).
- All database queries **must** be performed through the Repository pattern. The business logic must be encapsulated in a Service class, keeping the Controller lean. This three-tier structure (Controller -> Service -> Repository) is mandated by [`backend-architecture.md`](../../docs/architecture/backend-architecture.md).
- All code must adhere to the project's coding conventions, as outlined in [`docs/architecture/coding-standards.md`](../../docs/architecture/coding-standards.md).

### Testing

- A **Feature test** is required to validate the full request-response cycle of the API endpoint. This test will live in `backend/tests/Feature/Medication/` and should cover multiple scenarios (match found, no match found, empty search). The testing strategy is detailed in [`testing-strategy.md`](../../docs/architecture/testing-strategy.md).

## Change Log

| Date       | Version | Description                                 | Author       |
| :--------- | :------ | :------------------------------------------ | :----------- |
| 2025-09-01 | 1.0     | Initial draft created from parent story 1.2 | Scrum Master |

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Review Date: 2025-09-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is of high quality. It correctly follows the established Controller -> Service -> Repository architecture, uses dependency injection, and is clean, readable, and efficient. The code fully adheres to the project's architectural and coding standards.

### Refactoring Performed

None. No refactoring was necessary as the code quality is excellent.

### Compliance Check

- Coding Standards: ✓ - All code adheres to PSR-12 and includes the required PHPDoc comments.
- Project Structure: ✓ - All files are located correctly within the `backend/` directory structure.
- Testing Strategy: ✓ - The feature test provides excellent coverage for the acceptance criteria and follows the defined testing template.
- All ACs Met: ✓ - All acceptance criteria are fully implemented and validated by automated tests.

### Improvements Checklist

- [x] All required work is complete and of high quality.

### Security Review

No security concerns were found. The endpoint is public and read-only, and the use of Eloquent prevents SQL injection vulnerabilities.

### Performance Considerations

For the project's expected scale, the use of a `LIKE` query is acceptable. No performance issues are anticipated.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.1.2.1-create-public-medication-search-api-endpoint.yml

### Recommended Status

[✓ Ready for Done]
